<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Browser-based PV Line Listing Analyzer for pharmacovigilance professionals.">
  <title>PV Line Listing Analyzer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .icon{width:16px;height:16px;stroke:currentColor;stroke-width:2;fill:none;stroke-linecap:round;stroke-linejoin:round;display:inline-block;vertical-align:middle}
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000}
    .modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:8px;box-shadow:0 25px 50px rgba(0,0,0,0.3);z-index:1001}
  </style>
</head>
<body class="bg-gray-50">
<div id="root"></div>
<script type="text/babel">
const {useState,useCallback,useMemo,useEffect}=React;

const Icons={
  Upload:()=><svg className="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
  Filter:()=><svg className="icon" viewBox="0 0 24 24"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>,
  X:()=><svg className="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
  Search:()=><svg className="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
  ChevronDown:()=><svg className="icon" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>,
  ChevronUp:()=><svg className="icon" viewBox="0 0 24 24"><polyline points="18 15 12 9 6 15"/></svg>,
  Download:()=><svg className="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
  BarChart:()=><svg className="icon" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>,
  Copy:()=><svg className="icon" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
  AlertTriangle:()=><svg className="icon" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
  Plus:()=><svg className="icon" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
  Trash:()=><svg className="icon" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
  Edit:()=><svg className="icon" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
  RotateCcw:()=><svg className="icon" viewBox="0 0 24 24"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>,
  GitCompare:()=><svg className="icon" viewBox="0 0 24 24"><circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M13 6h3a2 2 0 0 1 2 2v7"/><path d="M11 18H8a2 2 0 0 1-2-2V9"/></svg>,
  Shield:()=><svg className="icon" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
  PieChart:()=><svg className="icon" viewBox="0 0 24 24"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>,
  Columns:()=><svg className="icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>,
  Lock:()=><svg className="icon" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
  Unlock:()=><svg className="icon" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>,
  Eye:()=><svg className="icon" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
  EyeOff:()=><svg className="icon" viewBox="0 0 24 24"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/><line x1="1" y1="1" x2="23" y2="23"/></svg>,
  Save:()=><svg className="icon" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/></svg>,
  Bookmark:()=><svg className="icon" viewBox="0 0 24 24"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>,
  GripVertical:()=><svg className="icon" viewBox="0 0 24 24"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg>,
};

const BLANK='__BLANK__';

const OPERATORS=[
  {id:'is_empty',name:'Is Empty',type:'none'},
  {id:'is_not_empty',name:'Is Not Empty',type:'none'},
  {id:'equals',name:'Equals',type:'text'},
  {id:'not_equals',name:'Not Equals',type:'text'},
  {id:'contains',name:'Contains',type:'text'},
  {id:'not_contains',name:'Not Contains',type:'text'},
  {id:'gt',name:'Greater Than',type:'number'},
  {id:'lt',name:'Less Than',type:'number'},
  {id:'gte',name:'Greater or Equal',type:'number'},
  {id:'lte',name:'Less or Equal',type:'number'},
  {id:'date_after_today',name:'Future Date',type:'none'},
  {id:'date_before_today',name:'Past Date',type:'none'},
  {id:'date_after',name:'Date After',type:'date'},
  {id:'date_before',name:'Date Before',type:'date'},
  {id:'length_lt',name:'Length Less Than',type:'number'},
  {id:'length_gt',name:'Length Greater Than',type:'number'},
  {id:'regex',name:'Matches Pattern',type:'text'},
];

const DEFAULT_RULES=[
  {id:'r1',name:'Missing Case Number',cat:'Missing Data',logic:'AND',conditions:[{field:'',op:'is_empty'}],fieldHints:['case','caseid'],builtin:true},
  {id:'r2',name:'Missing Product',cat:'Missing Data',logic:'AND',conditions:[{field:'',op:'is_empty'}],fieldHints:['product','drug'],builtin:true},
  {id:'r3',name:'Missing PT',cat:'Missing Data',logic:'AND',conditions:[{field:'',op:'is_empty'}],fieldHints:['pt','preferred term'],builtin:true},
  {id:'r4',name:'Future Receipt Date',cat:'Date Validation',logic:'AND',conditions:[{field:'',op:'date_after_today'}],fieldHints:['receipt','aware'],builtin:true},
  {id:'r5',name:'Future Onset Date',cat:'Date Validation',logic:'AND',conditions:[{field:'',op:'date_after_today'}],fieldHints:['onset'],builtin:true},
  {id:'r6',name:'Short Narrative',cat:'Data Quality',logic:'AND',conditions:[{field:'',op:'length_lt',value:'20'}],fieldHints:['narrative','summary'],builtin:true},
  {id:'r7',name:'Invalid Age (>120)',cat:'Data Quality',logic:'AND',conditions:[{field:'',op:'gt',value:'120'}],fieldHints:['age'],builtin:true},
  {id:'r8',name:'Serious but No Criteria',cat:'Logic Check',logic:'AND',conditions:[{field:'',op:'equals',value:'Yes'},{field:'',op:'is_empty'}],fieldHints:[['serious'],['criteria','death','hospital','disab','life','congeni']],builtin:true},
];

const evalCond=(row,c)=>{
  const v=row[c.field];
  const s=String(v??'').trim();
  const n=parseFloat(s);
  switch(c.op){
    case 'is_empty':return !s;
    case 'is_not_empty':return !!s;
    case 'equals':return s.toLowerCase()===String(c.value||'').toLowerCase();
    case 'not_equals':return s.toLowerCase()!==String(c.value||'').toLowerCase();
    case 'contains':return s.toLowerCase().includes(String(c.value||'').toLowerCase());
    case 'not_contains':return !s.toLowerCase().includes(String(c.value||'').toLowerCase());
    case 'gt':return !isNaN(n)&&n>parseFloat(c.value);
    case 'lt':return !isNaN(n)&&n<parseFloat(c.value);
    case 'gte':return !isNaN(n)&&n>=parseFloat(c.value);
    case 'lte':return !isNaN(n)&&n<=parseFloat(c.value);
    case 'date_after_today':return !isNaN(new Date(v))&&new Date(v)>new Date();
    case 'date_before_today':return !isNaN(new Date(v))&&new Date(v)<new Date();
    case 'date_after':return !isNaN(new Date(v))&&!isNaN(new Date(c.value))&&new Date(v)>new Date(c.value);
    case 'date_before':return !isNaN(new Date(v))&&!isNaN(new Date(c.value))&&new Date(v)<new Date(c.value);
    case 'length_lt':return s.length>0&&s.length<parseInt(c.value);
    case 'length_gt':return s.length>parseInt(c.value);
    case 'regex':try{return new RegExp(c.value,'i').test(s);}catch(e){return false;}
    default:return false;
  }
};

const evalRule=(row,rule)=>{
  if(!rule.conditions||!rule.conditions.length)return false;
  const results=rule.conditions.map(c=>c.field?evalCond(row,c):false);
  return rule.logic==='OR'?results.some(r=>r):results.every(r=>r);
};

// Filter Modal
const FilterModal=({col,data,filters,setFilters,onClose})=>{
  const [search,setSearch]=useState('');
  const [sel,setSel]=useState(filters[col]?.values||[]);
  const [dateRange,setDateRange]=useState(filters[col]?.dateRange||{from:'',to:''});
  
  const colInfo=useMemo(()=>{
    const all=data.map(r=>r[col]);
    const nonEmpty=all.filter(v=>v&&String(v).trim());
    let dateCount=0;
    const dateVals=[];
    nonEmpty.forEach(v=>{
      const d=v instanceof Date?v:new Date(v);
      if(!isNaN(d)&&d.getFullYear()>1900&&d.getFullYear()<2100){dateCount++;dateVals.push(d);}
    });
    const isDate=nonEmpty.length>0&&dateCount/nonEmpty.length>0.7;
    let minDate=null,maxDate=null;
    if(isDate&&dateVals.length){minDate=new Date(Math.min(...dateVals));maxDate=new Date(Math.max(...dateVals));}
    const hasBlank=all.some(v=>!v||!String(v).trim());
    const list=_.uniq(all.filter(v=>v&&String(v).trim()).map(v=>{
      if(isDate){const d=v instanceof Date?v:new Date(v);return !isNaN(d)?d.toISOString().split('T')[0]:String(v);}
      return String(v);
    })).sort();
    return {isDate,hasBlank,list,minDate,maxDate};
  },[data,col]);
  
  const filtered=search?colInfo.list.filter(v=>String(v).toLowerCase().includes(search.toLowerCase())):colInfo.list;
  const toggle=v=>setSel(p=>p.includes(v)?p.filter(x=>x!==v):[...p,v]);
  const formatDate=d=>d?d.toISOString().split('T')[0]:'';
  
  const apply=()=>{
    if(colInfo.isDate){
      if(!dateRange.from&&!dateRange.to&&!sel.includes(BLANK)){setFilters(p=>{const n={...p};delete n[col];return n;});}
      else{setFilters(p=>({...p,[col]:{type:'date',dateRange,includeBlank:sel.includes(BLANK)}}));}
    }else{
      if(!sel.length){setFilters(p=>{const n={...p};delete n[col];return n;});}
      else{setFilters(p=>({...p,[col]:{type:'values',values:sel}}));}
    }
    onClose();
  };
  
  return <><div className="modal-overlay" onClick={onClose}/><div className="modal" style={{width:420,maxHeight:'80vh',display:'flex',flexDirection:'column'}}>
    <div className="p-4 border-b flex justify-between items-center">
      <div><span className="font-semibold">Filter: {col}</span>{colInfo.isDate&&<span className="ml-2 text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded">Date</span>}</div>
      <button onClick={onClose}><Icons.X/></button>
    </div>
    {colInfo.isDate?<>
      <div className="p-4 border-b">
        <div className="text-sm font-medium mb-3">Date Range</div>
        <div className="grid grid-cols-2 gap-3">
          <div><label className="text-xs text-gray-500">From</label><input type="date" className="w-full px-3 py-2 border rounded mt-1" value={dateRange.from} onChange={e=>setDateRange(p=>({...p,from:e.target.value}))}/></div>
          <div><label className="text-xs text-gray-500">To</label><input type="date" className="w-full px-3 py-2 border rounded mt-1" value={dateRange.to} onChange={e=>setDateRange(p=>({...p,to:e.target.value}))}/></div>
        </div>
        <div className="flex flex-wrap gap-2 mt-3">
          <button onClick={()=>{const t=new Date();const f=new Date();f.setDate(f.getDate()-7);setDateRange({from:formatDate(f),to:formatDate(t)});}} className="text-xs px-2 py-1 bg-gray-100 rounded hover:bg-gray-200">Last 7 days</button>
          <button onClick={()=>{const t=new Date();const f=new Date();f.setDate(f.getDate()-30);setDateRange({from:formatDate(f),to:formatDate(t)});}} className="text-xs px-2 py-1 bg-gray-100 rounded hover:bg-gray-200">Last 30 days</button>
          <button onClick={()=>{const t=new Date();const f=new Date();f.setDate(f.getDate()-90);setDateRange({from:formatDate(f),to:formatDate(t)});}} className="text-xs px-2 py-1 bg-gray-100 rounded hover:bg-gray-200">Last 90 days</button>
          <button onClick={()=>{setDateRange({from:'',to:''});setSel([]);}} className="text-xs px-2 py-1 text-red-600 hover:bg-red-50 rounded">Clear</button>
        </div>
      </div>
      {colInfo.hasBlank&&<div className="px-4 py-3 border-b"><label className="flex items-center gap-2 cursor-pointer"><input type="checkbox" checked={sel.includes(BLANK)} onChange={()=>toggle(BLANK)} className="w-4 h-4"/><span className="text-sm">Include blank values</span></label></div>}
    </>:<>
      <div className="p-3 border-b"><input className="w-full px-3 py-2 border rounded" placeholder="Search values..." value={search} onChange={e=>setSearch(e.target.value)}/></div>
      <div className="px-3 py-2 border-b flex gap-3 bg-gray-50">
        <button onClick={()=>setSel([...colInfo.list,colInfo.hasBlank?BLANK:null].filter(Boolean))} className="text-sm text-blue-600">All</button>
        <button onClick={()=>setSel([])} className="text-sm text-red-600">Clear</button>
        <span className="ml-auto text-sm text-gray-500">{sel.length} selected</span>
      </div>
      <div className="flex-1 overflow-auto">
        {colInfo.hasBlank&&!search&&<div onClick={()=>toggle(BLANK)} className={`flex items-center gap-2 px-3 py-2 cursor-pointer border-b ${sel.includes(BLANK)?'bg-amber-100':'bg-amber-50'}`}><input type="checkbox" checked={sel.includes(BLANK)} readOnly/><span className="italic text-amber-700">(Blank)</span></div>}
        {filtered.slice(0,200).map(v=><div key={String(v)} onClick={()=>toggle(String(v))} className={`flex items-center gap-2 px-3 py-2 cursor-pointer border-b ${sel.includes(String(v))?'bg-blue-50':''}`}><input type="checkbox" checked={sel.includes(String(v))} readOnly/><span>{String(v)}</span></div>)}
      </div>
    </>}
    <div className="p-3 border-t flex justify-end gap-2"><button onClick={onClose} className="px-4 py-2 border rounded">Cancel</button><button onClick={apply} className="px-4 py-2 bg-blue-600 text-white rounded">Apply</button></div>
  </div></>;
};

// Stats Modal
const StatsModal=({col,data,onClose})=>{
  const s=useMemo(()=>{
    const all=data.map(r=>r[col]),total=all.length;
    const blank=all.filter(v=>!v||!String(v).trim()).length;
    const filled=total-blank;
    const uniq=_.uniq(all.filter(v=>v&&String(v).trim()).map(String)).length;
    const top=Object.entries(_.countBy(all.filter(v=>v&&String(v).trim()),String)).sort((a,b)=>b[1]-a[1]).slice(0,10);
    const nums=all.filter(v=>!isNaN(parseFloat(v))).map(v=>parseFloat(v));
    const isNum=nums.length>total*0.3;
    return {total,blank,filled,uniq,top,isNum,min:isNum?Math.min(...nums):0,max:isNum?Math.max(...nums):0,avg:isNum?nums.reduce((a,b)=>a+b,0)/nums.length:0};
  },[data,col]);
  
  return <><div className="modal-overlay" onClick={onClose}/><div className="modal" style={{width:480,maxHeight:'80vh',display:'flex',flexDirection:'column'}}>
    <div className="p-4 border-b flex justify-between"><span className="font-semibold">Statistics: {col}</span><button onClick={onClose}><Icons.X/></button></div>
    <div className="p-4 overflow-auto">
      <div className="grid grid-cols-2 gap-3 mb-4">
        <div className="bg-gray-50 p-3 rounded"><div className="text-2xl font-bold">{s.total.toLocaleString()}</div><div className="text-xs text-gray-500">Total</div></div>
        <div className="bg-blue-50 p-3 rounded"><div className="text-2xl font-bold text-blue-700">{s.uniq.toLocaleString()}</div><div className="text-xs text-blue-600">Unique</div></div>
        <div className="bg-green-50 p-3 rounded"><div className="text-2xl font-bold text-green-700">{s.filled.toLocaleString()}</div><div className="text-xs text-green-600">Filled ({(s.filled/s.total*100).toFixed(1)}%)</div></div>
        <div className="bg-amber-50 p-3 rounded"><div className="text-2xl font-bold text-amber-700">{s.blank.toLocaleString()}</div><div className="text-xs text-amber-600">Blank ({(s.blank/s.total*100).toFixed(1)}%)</div></div>
      </div>
      <div className="mb-4"><div className="h-3 bg-gray-200 rounded overflow-hidden"><div className="h-full bg-green-500" style={{width:`${s.filled/s.total*100}%`}}/></div></div>
      {s.isNum&&<div className="bg-gray-50 p-3 rounded mb-4 grid grid-cols-3 gap-2 text-sm"><div>Min: {s.min.toFixed(2)}</div><div>Max: {s.max.toFixed(2)}</div><div>Avg: {s.avg.toFixed(2)}</div></div>}
      {s.top.length>0&&<div><div className="font-medium mb-2">Top Values</div><table className="w-full text-sm"><tbody>{s.top.map(([v,c])=><tr key={v} className="border-b"><td className="py-1 truncate max-w-[250px]">{v}</td><td className="py-1 text-right">{c}</td><td className="py-1 text-right text-gray-500">{(c/s.total*100).toFixed(1)}%</td></tr>)}</tbody></table></div>}
    </div>
    <div className="p-3 border-t flex justify-end"><button onClick={onClose} className="px-4 py-2 bg-gray-200 rounded">Close</button></div>
  </div></>;
};

// Column Manager
const ColManager=({columns,config,setConfig,frozen,setFrozen})=>{
  const [open,setOpen]=useState(false);
  const sorted=useMemo(()=>[...columns].sort((a,b)=>(config[a]?.order??0)-(config[b]?.order??0)),[columns,config]);
  const vis=columns.filter(c=>config[c]?.visible!==false).length;
  const toggle=c=>setConfig(p=>({...p,[c]:{...p[c],visible:p[c]?.visible===false}}));
  const freeze=c=>setFrozen(p=>p.includes(c)?p.filter(x=>x!==c):[...p,c]);
  const reset=()=>{const c={};columns.forEach((col,i)=>c[col]={visible:true,order:i});setConfig(c);setFrozen([]);};
  const onDrag=(from,to)=>{const arr=[...sorted];const [m]=arr.splice(from,1);arr.splice(to,0,m);const c={...config};arr.forEach((col,i)=>c[col]={...c[col],order:i});setConfig(c);};
  
  return <div className="relative">
    <button onClick={()=>setOpen(!open)} className="flex items-center gap-2 px-3 py-2 bg-gray-100 rounded text-sm hover:bg-gray-200"><Icons.Columns/>Columns ({vis}/{columns.length})</button>
    {open&&<><div className="fixed inset-0 z-40" onClick={()=>setOpen(false)}/><div className="absolute top-full left-0 mt-1 bg-white border rounded-lg shadow-xl z-50 w-72" style={{maxHeight:'60vh',display:'flex',flexDirection:'column'}}>
      <div className="p-2 border-b flex justify-between items-center"><span className="text-sm font-medium">Columns</span><button onClick={reset} className="text-xs text-blue-600">Reset</button></div>
      <div className="flex-1 overflow-auto">{sorted.map((col,i)=><div key={col} draggable onDragStart={e=>e.dataTransfer.setData('idx',i)} onDragOver={e=>e.preventDefault()} onDrop={e=>{e.preventDefault();onDrag(+e.dataTransfer.getData('idx'),i);}} className={`flex items-center gap-2 px-2 py-1.5 border-b cursor-move hover:bg-gray-50 ${config[col]?.visible===false?'opacity-50':''}`}>
        <Icons.GripVertical/><span className="flex-1 text-sm truncate">{col}</span>
        <button onClick={()=>toggle(col)} className={config[col]?.visible===false?'text-gray-400':'text-green-600'}>{config[col]?.visible===false?<Icons.EyeOff/>:<Icons.Eye/>}</button>
        <button onClick={()=>freeze(col)} className={frozen.includes(col)?'text-blue-600':'text-gray-400'}>{frozen.includes(col)?<Icons.Lock/>:<Icons.Unlock/>}</button>
      </div>)}</div>
    </div></>}
  </div>;
};

// Views Manager
const ViewsManager=({views,setViews,config,frozen,applyView})=>{
  const [open,setOpen]=useState(false);
  const [name,setName]=useState('');
  const [saving,setSaving]=useState(false);
  const save=()=>{if(!name.trim())return;setViews(p=>[...p,{id:Date.now(),name:name.trim(),config:{...config},frozen:[...frozen]}]);setName('');setSaving(false);};
  const del=id=>setViews(p=>p.filter(v=>v.id!==id));
  
  return <div className="relative">
    <button onClick={()=>setOpen(!open)} className="flex items-center gap-2 px-3 py-2 bg-gray-100 rounded text-sm hover:bg-gray-200"><Icons.Bookmark/>Views{views.length>0&&<span className="bg-gray-300 px-1 rounded text-xs">{views.length}</span>}</button>
    {open&&<><div className="fixed inset-0 z-40" onClick={()=>setOpen(false)}/><div className="absolute top-full left-0 mt-1 bg-white border rounded-lg shadow-xl z-50 w-64">
      <div className="p-2 border-b flex justify-between"><span className="text-sm font-medium">Saved Views</span><button onClick={()=>setOpen(false)}><Icons.X/></button></div>
      {!saving?<><div className="max-h-48 overflow-auto">{views.length===0?<div className="p-4 text-center text-sm text-gray-500">No saved views</div>:views.map(v=><div key={v.id} className="flex items-center gap-2 px-3 py-2 border-b hover:bg-gray-50"><span className="flex-1 text-sm cursor-pointer" onClick={()=>{applyView(v);setOpen(false);}}>{v.name}</span><button onClick={()=>del(v.id)} className="text-gray-400 hover:text-red-600"><Icons.Trash/></button></div>)}</div>
        <div className="p-2 border-t"><button onClick={()=>setSaving(true)} className="w-full px-3 py-2 bg-blue-600 text-white rounded text-sm"><Icons.Save/> Save Current</button></div>
      </>:<div className="p-3"><input className="w-full px-3 py-2 border rounded text-sm mb-2" placeholder="View name..." value={name} onChange={e=>setName(e.target.value)} autoFocus/><div className="flex gap-2"><button onClick={()=>setSaving(false)} className="flex-1 px-3 py-2 border rounded text-sm">Cancel</button><button onClick={save} className="flex-1 px-3 py-2 bg-blue-600 text-white rounded text-sm">Save</button></div></div>}
    </div></>}
  </div>;
};

// Duplicate Modal
const DupModal=({columns,data,onClose,onShow})=>{
  const [sel,setSel]=useState([]);
  const [res,setRes]=useState(null);
  const find=()=>{const m=new Map();data.forEach((r,i)=>{const k=sel.map(c=>String(r[c]??'')).join('|');if(!m.has(k))m.set(k,[]);m.get(k).push(i);});const d=[];m.forEach((idx,k)=>{if(idx.length>1)d.push({k,idx,n:idx.length});});d.sort((a,b)=>b.n-a.n);setRes(d);};
  
  return <><div className="modal-overlay" onClick={onClose}/><div className="modal" style={{width:500,maxHeight:'80vh',display:'flex',flexDirection:'column'}}>
    <div className="p-4 border-b flex justify-between"><span className="font-semibold">Find Duplicates</span><button onClick={onClose}><Icons.X/></button></div>
    {!res?<><div className="p-2 border-b flex gap-2"><button onClick={()=>setSel([...columns])} className="text-sm text-blue-600">All</button><button onClick={()=>setSel([])} className="text-sm text-red-600">Clear</button><span className="ml-auto text-sm">{sel.length} cols</span></div>
      <div className="flex-1 overflow-auto">{columns.map(c=><div key={c} onClick={()=>setSel(p=>p.includes(c)?p.filter(x=>x!==c):[...p,c])} className={`flex items-center gap-2 px-3 py-2 border-b cursor-pointer ${sel.includes(c)?'bg-blue-50':''}`}><input type="checkbox" checked={sel.includes(c)} readOnly/><span>{c}</span></div>)}</div>
      <div className="p-3 border-t flex justify-end gap-2"><button onClick={onClose} className="px-4 py-2 border rounded">Cancel</button><button onClick={find} disabled={!sel.length} className="px-4 py-2 bg-blue-600 text-white rounded disabled:opacity-50">Find</button></div>
    </>:<><div className="flex-1 overflow-auto p-4">{res.length===0?<div className="text-center py-8 text-green-600">✓ No duplicates</div>:<><div className="bg-amber-50 p-3 rounded mb-4 flex justify-between"><span><b>{res.length}</b> groups</span><button onClick={()=>{onShow(res.flatMap(r=>r.idx));onClose();}} className="text-sm bg-amber-600 text-white px-3 py-1 rounded">Show All</button></div>{res.slice(0,50).map((r,i)=><div key={i} className="border-b py-2 flex justify-between"><span className="text-sm truncate flex-1">{r.k}</span><span className="bg-amber-100 px-2 rounded mx-2">{r.n}</span><button onClick={()=>{onShow(r.idx);onClose();}} className="text-sm text-blue-600">Show</button></div>)}</>}</div>
      <div className="p-3 border-t flex justify-between"><button onClick={()=>setRes(null)} className="text-blue-600">← Back</button><button onClick={onClose} className="px-4 py-2 bg-gray-200 rounded">Close</button></div></>}
  </div></>;
};

// QC Modal with Multi-Condition Support
const QCModal=({columns,data,onClose,onShow,rules,setRules})=>{
  const [tab,setTab]=useState('rules');
  const [en,setEn]=useState(rules.map(r=>r.id));
  const [res,setRes]=useState(null);
  const [edit,setEdit]=useState(null);
  
  useEffect(()=>{
    if(columns.length){
      setRules(p=>p.map(r=>{
        if(!r.fieldHints)return r;
        const newConds=r.conditions.map((c,i)=>{
          if(c.field)return c;
          const hints=Array.isArray(r.fieldHints[i])?r.fieldHints[i]:(i===0?r.fieldHints:[]);
          const m=columns.find(col=>hints.some(h=>col.toLowerCase().includes(h)));
          return m?{...c,field:m}:c;
        });
        return {...r,conditions:newConds};
      }));
    }
  },[columns]);
  
  const run=()=>{
    const f=[];
    rules.filter(r=>en.includes(r.id)&&r.conditions.some(c=>c.field)).forEach(r=>{
      const rows=[];
      data.forEach((row,i)=>{if(evalRule(row,r))rows.push(i);});
      if(rows.length)f.push({r,rows,n:rows.length});
    });
    f.sort((a,b)=>b.n-a.n);
    setRes(f);
    setTab('results');
  };
  
  const addCondition=()=>{
    setEdit(p=>({...p,conditions:[...p.conditions,{field:'',op:'is_empty',value:''}]}));
  };
  
  const removeCondition=(idx)=>{
    if(edit.conditions.length<=1)return;
    setEdit(p=>({...p,conditions:p.conditions.filter((_,i)=>i!==idx)}));
  };
  
  const updateCondition=(idx,updates)=>{
    setEdit(p=>({...p,conditions:p.conditions.map((c,i)=>i===idx?{...c,...updates}:c)}));
  };
  
  const save=rule=>{
    const i=rules.findIndex(r=>r.id===rule.id);
    if(i>=0)setRules(p=>p.map((r,j)=>j===i?rule:r));
    else setRules(p=>[...p,rule]);
    if(!en.includes(rule.id))setEn(p=>[...p,rule.id]);
    setEdit(null);
  };
  
  const del=id=>{setRules(p=>p.filter(r=>r.id!==id));setEn(p=>p.filter(x=>x!==id));};
  
  const conditionSummary=(r)=>{
    const mapped=r.conditions.filter(c=>c.field).length;
    const total=r.conditions.length;
    if(mapped===0)return <span className="text-amber-600">• Not mapped</span>;
    if(mapped<total)return <span className="text-amber-600">• {mapped}/{total} mapped</span>;
    if(total>1)return <span className="text-blue-600">• {total} conditions ({r.logic})</span>;
    return null;
  };
  
  return <><div className="modal-overlay" onClick={onClose}/><div className="modal" style={{width:750,maxHeight:'85vh',display:'flex',flexDirection:'column'}}>
    <div className="p-4 border-b flex justify-between"><span className="font-semibold flex items-center gap-2"><Icons.AlertTriangle/>QC Rules</span><button onClick={onClose}><Icons.X/></button></div>
    <div className="flex border-b">
      <button onClick={()=>setTab('rules')} className={`flex-1 py-2 text-sm ${tab==='rules'?'border-b-2 border-blue-600 text-blue-600':'text-gray-500'}`}>Rules ({rules.length})</button>
      <button onClick={()=>setTab('results')} className={`flex-1 py-2 text-sm ${tab==='results'?'border-b-2 border-blue-600 text-blue-600':'text-gray-500'}`}>Results</button>
    </div>
    <div className="flex-1 overflow-auto p-4">
      {tab==='rules'&&!edit&&<>
        <div className="flex gap-2 mb-4">
          <button onClick={()=>setEdit({id:'c'+Date.now(),name:'',cat:'Custom',logic:'AND',conditions:[{field:'',op:'is_empty',value:''}]})} className="px-3 py-2 bg-blue-600 text-white rounded text-sm"><Icons.Plus/> New Rule</button>
          <button onClick={()=>setRules(DEFAULT_RULES.map(r=>({...r,conditions:r.conditions.map(c=>({...c}))})))} className="px-3 py-2 bg-gray-100 rounded text-sm"><Icons.RotateCcw/> Reset</button>
        </div>
        {rules.map(r=><div key={r.id} className={`flex items-center gap-2 px-3 py-2 border rounded mb-1 ${en.includes(r.id)?'bg-white':'bg-gray-50 opacity-60'}`}>
          <input type="checkbox" checked={en.includes(r.id)} onChange={()=>setEn(p=>p.includes(r.id)?p.filter(x=>x!==r.id):[...p,r.id])}/>
          <div className="flex-1"><div>{r.name}</div><div className="text-xs text-gray-500">{r.cat} {conditionSummary(r)}</div></div>
          {r.builtin&&<span className="text-xs bg-blue-100 text-blue-600 px-2 rounded">Built-in</span>}
          <button onClick={()=>setEdit({...r,conditions:r.conditions.map(c=>({...c}))})} className="p-1 text-gray-400 hover:text-blue-600"><Icons.Edit/></button>
          <button onClick={()=>del(r.id)} className="p-1 text-gray-400 hover:text-red-600"><Icons.Trash/></button>
        </div>)}
      </>}
      
      {tab==='rules'&&edit&&<div className="space-y-4">
        <div className="grid grid-cols-2 gap-4">
          <div><label className="text-sm font-medium">Rule Name</label><input className="w-full px-3 py-2 border rounded mt-1" value={edit.name} onChange={e=>setEdit({...edit,name:e.target.value})} placeholder="e.g., Missing Critical Data"/></div>
          <div><label className="text-sm font-medium">Category</label><select className="w-full px-3 py-2 border rounded mt-1" value={edit.cat} onChange={e=>setEdit({...edit,cat:e.target.value})}><option>Missing Data</option><option>Date Validation</option><option>Data Quality</option><option>Logic Check</option><option>Custom</option></select></div>
        </div>
        
        <div className="border rounded p-3 bg-gray-50">
          <div className="flex items-center justify-between mb-3">
            <label className="text-sm font-medium">Conditions</label>
            <div className="flex items-center gap-2">
              <span className="text-xs text-gray-500">Match:</span>
              <select className="px-2 py-1 border rounded text-sm bg-white" value={edit.logic} onChange={e=>setEdit({...edit,logic:e.target.value})}>
                <option value="AND">ALL conditions (AND)</option>
                <option value="OR">ANY condition (OR)</option>
              </select>
            </div>
          </div>
          
          {edit.conditions.map((c,idx)=><div key={idx} className="flex gap-2 mb-2 items-start">
            <div className="flex-1 grid grid-cols-3 gap-2">
              <select className="px-2 py-2 border rounded text-sm" value={c.field} onChange={e=>updateCondition(idx,{field:e.target.value})}>
                <option value="">-- Select Field --</option>
                {columns.map(col=><option key={col} value={col}>{col}</option>)}
              </select>
              <select className="px-2 py-2 border rounded text-sm" value={c.op} onChange={e=>updateCondition(idx,{op:e.target.value})}>
                {OPERATORS.map(o=><option key={o.id} value={o.id}>{o.name}</option>)}
              </select>
              {OPERATORS.find(o=>o.id===c.op)?.type==='none'?<div/>:
                OPERATORS.find(o=>o.id===c.op)?.type==='date'?
                <input type="date" className="px-2 py-2 border rounded text-sm" value={c.value||''} onChange={e=>updateCondition(idx,{value:e.target.value})}/>:
                <input className="px-2 py-2 border rounded text-sm" placeholder="Value" value={c.value||''} onChange={e=>updateCondition(idx,{value:e.target.value})}/>
              }
            </div>
            <button onClick={()=>removeCondition(idx)} disabled={edit.conditions.length<=1} className="p-2 text-gray-400 hover:text-red-600 disabled:opacity-30"><Icons.Trash/></button>
          </div>)}
          
          <button onClick={addCondition} className="mt-2 px-3 py-1 text-sm text-blue-600 border border-blue-300 rounded hover:bg-blue-50"><Icons.Plus/> Add Condition</button>
        </div>
        
        <div className="bg-blue-50 border border-blue-200 rounded p-3 text-sm">
          <strong>Preview:</strong> Flag rows where {edit.logic==='AND'?'ALL':'ANY'} of these are true:
          <ul className="mt-1 ml-4 list-disc text-gray-600">
            {edit.conditions.map((c,i)=><li key={i}>{c.field||'[field]'} {OPERATORS.find(o=>o.id===c.op)?.name||c.op} {c.value||''}</li>)}
          </ul>
        </div>
        
        <div className="flex gap-2">
          <button onClick={()=>setEdit(null)} className="px-4 py-2 border rounded">Cancel</button>
          <button onClick={()=>save(edit)} disabled={!edit.name||!edit.conditions.some(c=>c.field)} className="px-4 py-2 bg-blue-600 text-white rounded disabled:opacity-50">Save Rule</button>
        </div>
      </div>}
      
      {tab==='results'&&<>{!res?<div className="text-center py-8"><button onClick={run} className="px-6 py-2 bg-blue-600 text-white rounded">Run QC ({en.length} rules)</button></div>:
        res.length===0?<div className="text-center py-8 text-green-600 text-xl">✓ No issues found</div>:<>
          <div className="bg-amber-50 p-3 rounded mb-4 flex justify-between"><span><b>{res.reduce((s,r)=>s+r.n,0)}</b> issues in <b>{res.length}</b> rules</span><button onClick={()=>{onShow(res.flatMap(r=>r.rows));onClose();}} className="text-sm bg-amber-600 text-white px-3 py-1 rounded">Show All</button></div>
          {res.map((r,i)=><div key={i} className="border rounded p-3 mb-2 flex justify-between">
            <div><div className="font-medium">{r.r.name}</div><div className="text-xs text-gray-500">{r.r.cat} • {r.r.conditions.length} condition{r.r.conditions.length>1?`s (${r.r.logic})`:''}</div></div>
            <div className="flex items-center gap-2"><span className="bg-amber-100 px-2 py-1 rounded">{r.n}</span><button onClick={()=>{onShow(r.rows);onClose();}} className="text-sm text-blue-600">Show</button></div>
          </div>)}</>}</>}
    </div>
    <div className="p-3 border-t flex justify-end gap-2">{tab==='results'&&res&&<button onClick={()=>setRes(null)} className="px-4 py-2 border rounded">Clear</button>}<button onClick={run} className="px-4 py-2 bg-blue-600 text-white rounded">Run</button><button onClick={onClose} className="px-4 py-2 bg-gray-200 rounded">Close</button></div>
  </div></>;
};

// Summary Dashboard Modal
const SummaryModal=({columns,data,onClose})=>{
  // Auto-detect columns by common PV naming patterns
  const findCol=(hints)=>columns.find(c=>hints.some(h=>c.toLowerCase().includes(h.toLowerCase())));
  
  // Editable column mappings
  const [mappings,setMappings]=useState(()=>({
    case:findCol(['case','caseid','case number','case id','case_id'])||'',
    product:findCol(['product','drug','suspect','medication','medicine'])||'',
    pt:findCol(['preferred term','event term','event pt','adverse event'])||'',
    serious:findCol(['serious','seriousness'])||'',
    outcome:findCol(['outcome'])||'',
    age:findCol(['age'])||'',
    gender:findCol(['gender','sex'])||'',
    country:findCol(['country','nation'])||'',
    reporter:findCol(['reporter','qualification','report type'])||'',
    receipt:findCol(['receipt','aware','receive','initial'])||'',
  }));
  
  const [showMapping,setShowMapping]=useState(false);
  const [tab,setTab]=useState('summary');
  
  const updateMapping=(key,val)=>setMappings(p=>({...p,[key]:val}));
  
  const MAPPING_LABELS={
    case:'Case ID',
    product:'Product/Drug',
    pt:'Event PT',
    serious:'Seriousness',
    outcome:'Outcome',
    age:'Age',
    gender:'Gender',
    country:'Country',
    reporter:'Reporter Type',
    receipt:'Receipt Date'
  };

  const stats=useMemo(()=>{
    const s={totalRows:data.length};
    const {case:caseCol,product:productCol,pt:ptCol,serious:seriousCol,outcome:outcomeCol,age:ageCol,gender:genderCol,country:countryCol,reporter:reporterCol,receipt:receiptCol}=mappings;
    
    // Unique cases
    if(caseCol){
      const cases=data.map(r=>r[caseCol]).filter(v=>v&&String(v).trim());
      s.uniqueCases=_.uniq(cases).length;
      s.caseCol=caseCol;
    }
    
    // Products
    if(productCol){
      const prods=data.map(r=>r[productCol]).filter(v=>v&&String(v).trim());
      s.uniqueProducts=_.uniq(prods).length;
      s.topProducts=Object.entries(_.countBy(prods)).sort((a,b)=>b[1]-a[1]).slice(0,5);
      s.productCol=productCol;
    }
    
    // Events/PTs
    if(ptCol){
      const pts=data.map(r=>r[ptCol]).filter(v=>v&&String(v).trim());
      s.uniquePTs=_.uniq(pts).length;
      s.topPTs=Object.entries(_.countBy(pts)).sort((a,b)=>b[1]-a[1]).slice(0,10);
      s.ptCol=ptCol;
    }
    
    // Seriousness
    if(seriousCol){
      const vals=data.map(r=>String(r[seriousCol]||'').toLowerCase().trim());
      s.serious=vals.filter(v=>v==='yes'||v==='y'||v==='true'||v==='1').length;
      s.nonSerious=vals.filter(v=>v==='no'||v==='n'||v==='false'||v==='0').length;
      s.seriousCol=seriousCol;
    }
    
    // Outcomes
    if(outcomeCol){
      const outcomes=data.map(r=>r[outcomeCol]).filter(v=>v&&String(v).trim());
      s.outcomeBreakdown=Object.entries(_.countBy(outcomes)).sort((a,b)=>b[1]-a[1]);
      s.outcomeCol=outcomeCol;
    }
    
    // Age distribution
    if(ageCol){
      const ages=data.map(r=>parseFloat(r[ageCol])).filter(n=>!isNaN(n)&&n>=0&&n<=120);
      if(ages.length){
        s.ageRanges={'0-17':0,'18-44':0,'45-64':0,'65-84':0,'85+':0};
        ages.forEach(a=>{if(a<18)s.ageRanges['0-17']++;else if(a<45)s.ageRanges['18-44']++;else if(a<65)s.ageRanges['45-64']++;else if(a<85)s.ageRanges['65-84']++;else s.ageRanges['85+']++;});
        s.avgAge=(ages.reduce((a,b)=>a+b,0)/ages.length).toFixed(1);
        s.ageCol=ageCol;
      }
    }
    
    // Gender
    if(genderCol){
      const genders=data.map(r=>String(r[genderCol]||'').toUpperCase().trim()).filter(v=>v);
      s.genderBreakdown={};
      genders.forEach(g=>{
        const key=g.startsWith('M')?'Male':g.startsWith('F')?'Female':'Other/Unknown';
        s.genderBreakdown[key]=(s.genderBreakdown[key]||0)+1;
      });
      s.genderCol=genderCol;
    }
    
    // Countries
    if(countryCol){
      const countries=data.map(r=>r[countryCol]).filter(v=>v&&String(v).trim());
      s.uniqueCountries=_.uniq(countries).length;
      s.topCountries=Object.entries(_.countBy(countries)).sort((a,b)=>b[1]-a[1]).slice(0,5);
      s.countryCol=countryCol;
    }
    
    // Reporter types
    if(reporterCol){
      const reporters=data.map(r=>r[reporterCol]).filter(v=>v&&String(v).trim());
      s.reporterBreakdown=Object.entries(_.countBy(reporters)).sort((a,b)=>b[1]-a[1]);
      s.reporterCol=reporterCol;
    }
    
    // Timeline
    if(receiptCol){
      const dates=data.map(r=>{const v=r[receiptCol];const d=v instanceof Date?v:new Date(v);return !isNaN(d)?d:null;}).filter(Boolean);
      if(dates.length){
        dates.sort((a,b)=>a-b);
        s.dateRange={from:dates[0],to:dates[dates.length-1]};
        const byMonth={};
        dates.forEach(d=>{const key=d.toISOString().slice(0,7);byMonth[key]=(byMonth[key]||0)+1;});
        s.timeline=Object.entries(byMonth).sort((a,b)=>a[0].localeCompare(b[0])).slice(-12);
        s.receiptCol=receiptCol;
      }
    }
    
    // Data Quality - fill rates for key fields
    s.fillRates=columns.slice(0,15).map(col=>{
      const filled=data.filter(r=>r[col]&&String(r[col]).trim()).length;
      return {col,filled,pct:(filled/data.length*100).toFixed(1)};
    }).sort((a,b)=>a.pct-b.pct);
    
    return s;
  },[data,columns,mappings]);
  
  const StatCard=({label,value,sub,color='blue'})=>(
    <div className={`bg-${color}-50 p-4 rounded-lg`}>
      <div className={`text-2xl font-bold text-${color}-700`}>{value?.toLocaleString?.()??value}</div>
      <div className={`text-sm text-${color}-600`}>{label}</div>
      {sub&&<div className="text-xs text-gray-500 mt-1">{sub}</div>}
    </div>
  );
  
  const BarChart=({data:chartData,maxWidth=200})=>{
    const max=Math.max(...chartData.map(d=>d[1]));
    return <div className="space-y-1">{chartData.map(([label,count],i)=>(
      <div key={i} className="flex items-center gap-2 text-sm">
        <div className="w-32 truncate text-gray-600" title={label}>{label}</div>
        <div className="flex-1 h-5 bg-gray-100 rounded overflow-hidden">
          <div className="h-full bg-blue-500 rounded" style={{width:`${count/max*100}%`}}/>
        </div>
        <div className="w-12 text-right text-gray-500">{count}</div>
      </div>
    ))}</div>;
  };
  
  const MiniPie=({data:pieData,colors=['#3b82f6','#ef4444','#10b981','#f59e0b','#8b5cf6']})=>{
    const total=Object.values(pieData).reduce((a,b)=>a+b,0);
    if(total===0)return <div className="text-gray-400 text-sm">No data</div>;
    let cumulative=0;
    const segments=Object.entries(pieData).map(([k,v],i)=>{
      const start=cumulative;
      cumulative+=v/total*360;
      return {label:k,value:v,pct:(v/total*100).toFixed(1),color:colors[i%colors.length],start,end:cumulative};
    });
    return <div className="flex items-center gap-4">
      <svg width="80" height="80" viewBox="0 0 42 42">
        <circle cx="21" cy="21" r="15.9" fill="transparent" stroke="#e5e7eb" strokeWidth="8"/>
        {segments.map((seg,i)=>{
          const circumference=2*Math.PI*15.9;
          const offset=circumference*(1-seg.start/360);
          const length=circumference*((seg.end-seg.start)/360);
          return <circle key={i} cx="21" cy="21" r="15.9" fill="transparent" stroke={seg.color} strokeWidth="8" strokeDasharray={`${length} ${circumference-length}`} strokeDashoffset={offset} transform="rotate(-90 21 21)"/>;
        })}
      </svg>
      <div className="text-xs space-y-1">{segments.map((seg,i)=>(
        <div key={i} className="flex items-center gap-2"><span className="w-3 h-3 rounded" style={{background:seg.color}}/><span>{seg.label}: {seg.pct}%</span></div>
      ))}</div>
    </div>;
  };
  
  const mappedCount=Object.values(mappings).filter(v=>v).length;
  
  return <><div className="modal-overlay" onClick={onClose}/><div className="modal" style={{width:900,maxHeight:'90vh',display:'flex',flexDirection:'column'}}>
    <div className="p-4 border-b flex justify-between items-center bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-t-lg">
      <span className="font-semibold flex items-center gap-2"><Icons.PieChart/>Data Summary & Insights</span>
      <button onClick={onClose} className="p-1 hover:bg-white/20 rounded"><Icons.X/></button>
    </div>
    
    {/* Tabs */}
    <div className="flex border-b">
      <button onClick={()=>setTab('summary')} className={`flex-1 py-2 text-sm ${tab==='summary'?'border-b-2 border-blue-600 text-blue-600':'text-gray-500'}`}>Summary</button>
      <button onClick={()=>setTab('mapping')} className={`flex-1 py-2 text-sm ${tab==='mapping'?'border-b-2 border-blue-600 text-blue-600':'text-gray-500'}`}>
        Column Mapping ({mappedCount}/10)
        {mappedCount<5&&<span className="ml-1 text-amber-500">⚠</span>}
      </button>
    </div>
    
    <div className="flex-1 overflow-auto p-4">
      {tab==='mapping'&&<div>
        <div className="bg-blue-50 border border-blue-200 rounded p-3 mb-4 text-sm">
          <strong>Column Mapping</strong> - Review and correct the auto-detected column mappings. Select the correct column from your data for each field, or leave blank if not available.
        </div>
        <div className="grid grid-cols-2 gap-4">
          {Object.entries(MAPPING_LABELS).map(([key,label])=>(
            <div key={key} className="flex items-center gap-3">
              <label className="w-32 text-sm font-medium text-gray-700">{label}</label>
              <select 
                className={`flex-1 px-3 py-2 border rounded text-sm ${mappings[key]?'border-green-300 bg-green-50':'border-gray-300'}`}
                value={mappings[key]} 
                onChange={e=>updateMapping(key,e.target.value)}
              >
                <option value="">-- Not Mapped --</option>
                {columns.map(c=><option key={c} value={c}>{c}</option>)}
              </select>
            </div>
          ))}
        </div>
        <div className="mt-4 flex gap-2">
          <button onClick={()=>{
            setMappings({
              case:findCol(['case','caseid','case number','case id','case_id'])||'',
              product:findCol(['product','drug','suspect','medication','medicine'])||'',
              pt:findCol(['preferred term','pt','event term','event pt','adverse event'])||'',
              serious:findCol(['serious','seriousness'])||'',
              outcome:findCol(['outcome'])||'',
              age:findCol(['age'])||'',
              gender:findCol(['gender','sex'])||'',
              country:findCol(['country','nation'])||'',
              reporter:findCol(['reporter','qualification','report type'])||'',
              receipt:findCol(['receipt','aware','receive','initial'])||'',
            });
          }} className="px-3 py-2 bg-gray-100 rounded text-sm hover:bg-gray-200">
            <Icons.RotateCcw/> Reset to Auto-Detect
          </button>
          <button onClick={()=>{
            setMappings({case:'',product:'',pt:'',serious:'',outcome:'',age:'',gender:'',country:'',reporter:'',receipt:''});
          }} className="px-3 py-2 bg-gray-100 rounded text-sm hover:bg-gray-200">
            Clear All
          </button>
        </div>
        <div className="mt-6 p-3 bg-gray-50 rounded">
          <div className="text-sm font-medium mb-2">Preview of Mapped Data (First 3 rows)</div>
          <div className="overflow-auto">
            <table className="text-xs w-full">
              <thead><tr className="bg-gray-200">
                {Object.entries(MAPPING_LABELS).filter(([k])=>mappings[k]).map(([k,label])=>(
                  <th key={k} className="p-2 text-left">{label}</th>
                ))}
              </tr></thead>
              <tbody>
                {data.slice(0,3).map((row,i)=>(
                  <tr key={i} className="border-b">
                    {Object.entries(MAPPING_LABELS).filter(([k])=>mappings[k]).map(([k])=>(
                      <td key={k} className="p-2 truncate max-w-[150px]">{row[mappings[k]] instanceof Date?row[mappings[k]].toLocaleDateString():String(row[mappings[k]]??'')}</td>
                    ))}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </div>}
      
      {tab==='summary'&&<>
        {/* Overview Cards */}
        <div className="grid grid-cols-4 gap-3 mb-6">
          <StatCard label="Total Rows" value={stats.totalRows} color="gray"/>
          {stats.uniqueCases!==undefined&&<StatCard label="Unique Cases" value={stats.uniqueCases} sub={`Column: ${stats.caseCol}`} color="blue"/>}
          {stats.uniqueProducts!==undefined&&<StatCard label="Unique Products" value={stats.uniqueProducts} sub={`Column: ${stats.productCol}`} color="green"/>}
          {stats.uniquePTs!==undefined&&<StatCard label="Unique Events (PT)" value={stats.uniquePTs} sub={`Column: ${stats.ptCol}`} color="purple"/>}
        </div>
        
        {mappedCount<3&&<div className="mb-6 p-3 bg-amber-50 border border-amber-200 rounded-lg text-sm text-amber-800">
          <strong>⚠ Limited Data:</strong> Only {mappedCount} columns are mapped. Go to the "Column Mapping" tab to map more columns for a complete summary.
        </div>}
        
        {/* Date Range */}
        {stats.dateRange&&<div className="mb-6 p-3 bg-gray-50 rounded-lg flex items-center gap-4">
          <span className="text-sm text-gray-500">Date Range:</span>
          <span className="font-medium">{stats.dateRange.from.toLocaleDateString()} → {stats.dateRange.to.toLocaleDateString()}</span>
          <span className="text-sm text-gray-500">({stats.timeline?.length} months of data)</span>
        </div>}
        
        <div className="grid grid-cols-2 gap-6">
          {/* Left Column */}
          <div className="space-y-6">
            {stats.topPTs&&<div className="border rounded-lg p-4">
              <h3 className="font-semibold mb-3 flex items-center gap-2"><Icons.AlertTriangle className="text-red-500"/>Top Events (PT)</h3>
              <BarChart data={stats.topPTs}/>
            </div>}
            
            {stats.topProducts&&<div className="border rounded-lg p-4">
              <h3 className="font-semibold mb-3">Top Products</h3>
              <BarChart data={stats.topProducts}/>
            </div>}
            
            {stats.topCountries&&<div className="border rounded-lg p-4">
              <h3 className="font-semibold mb-3">Top Countries</h3>
              <BarChart data={stats.topCountries}/>
            </div>}
            
            {stats.timeline&&stats.timeline.length>1&&<div className="border rounded-lg p-4">
              <h3 className="font-semibold mb-3">Cases Over Time</h3>
              <div className="flex items-end gap-1 h-32">
                {stats.timeline.map(([month,count],i)=>{
                  const max=Math.max(...stats.timeline.map(t=>t[1]));
                  const heightPct=max>0?(count/max*100):0;
                  return <div key={i} className="flex-1 flex flex-col items-center justify-end">
                    <div className="text-xs text-gray-600 mb-1">{count}</div>
                    <div className="w-full bg-blue-500 rounded-t transition-all" style={{height:`${Math.max(heightPct,2)}%`,minHeight:count>0?'4px':'0'}}/>
                    <div className="text-xs text-gray-400 mt-1 w-full text-center truncate" title={month}>{month.slice(5)}</div>
                  </div>;
                })}
              </div>
              <div className="text-xs text-gray-400 mt-2 text-center">
                Total: {stats.timeline.reduce((sum,t)=>sum+t[1],0)} cases from {stats.timeline[0]?.[0]} to {stats.timeline[stats.timeline.length-1]?.[0]}
              </div>
            </div>}
          </div>
          
          {/* Right Column */}
          <div className="space-y-6">
            {stats.seriousCol&&<div className="border rounded-lg p-4">
              <h3 className="font-semibold mb-3">Seriousness</h3>
              <MiniPie data={{Serious:stats.serious||0,'Non-Serious':stats.nonSerious||0}} colors={['#ef4444','#10b981']}/>
            </div>}
            
            {stats.genderBreakdown&&Object.keys(stats.genderBreakdown).length>0&&<div className="border rounded-lg p-4">
              <h3 className="font-semibold mb-3">Gender Distribution</h3>
              <MiniPie data={stats.genderBreakdown} colors={['#3b82f6','#ec4899','#9ca3af']}/>
            </div>}
            
            {stats.outcomeBreakdown&&stats.outcomeBreakdown.length>0&&<div className="border rounded-lg p-4">
              <h3 className="font-semibold mb-3">Outcomes</h3>
              <div className="space-y-1">{stats.outcomeBreakdown.slice(0,6).map(([label,count],i)=>(
                <div key={i} className="flex justify-between text-sm"><span className="truncate">{label}</span><span className="text-gray-500">{count} ({(count/stats.totalRows*100).toFixed(1)}%)</span></div>
              ))}</div>
            </div>}
            
            {stats.ageRanges&&<div className="border rounded-lg p-4">
              <h3 className="font-semibold mb-3">Age Distribution <span className="font-normal text-sm text-gray-500">(Avg: {stats.avgAge})</span></h3>
              <div className="space-y-1">{Object.entries(stats.ageRanges).map(([range,count],i)=>(
                <div key={i} className="flex items-center gap-2 text-sm">
                  <div className="w-12 text-gray-600">{range}</div>
                  <div className="flex-1 h-4 bg-gray-100 rounded overflow-hidden">
                    <div className="h-full bg-purple-500 rounded" style={{width:`${count/stats.totalRows*100}%`}}/>
                  </div>
                  <div className="w-16 text-right text-gray-500">{count} ({(count/stats.totalRows*100).toFixed(0)}%)</div>
                </div>
              ))}</div>
            </div>}
            
            {stats.reporterBreakdown&&stats.reporterBreakdown.length>0&&<div className="border rounded-lg p-4">
              <h3 className="font-semibold mb-3">Reporter Types</h3>
              <div className="space-y-1">{stats.reporterBreakdown.slice(0,5).map(([label,count],i)=>(
                <div key={i} className="flex justify-between text-sm"><span className="truncate">{label}</span><span className="text-gray-500">{count}</span></div>
              ))}</div>
            </div>}
          </div>
        </div>
        
        {/* Data Quality Section */}
        <div className="mt-6 border rounded-lg p-4">
          <h3 className="font-semibold mb-3">Data Quality - Fill Rates (Lowest First)</h3>
          <div className="grid grid-cols-3 gap-2">
            {stats.fillRates.slice(0,12).map((f,i)=>(
              <div key={i} className="flex items-center gap-2 text-sm">
                <div className="w-24 truncate text-gray-600" title={f.col}>{f.col}</div>
                <div className="flex-1 h-3 bg-gray-100 rounded overflow-hidden">
                  <div className={`h-full rounded ${parseFloat(f.pct)<50?'bg-red-500':parseFloat(f.pct)<80?'bg-amber-500':'bg-green-500'}`} style={{width:`${f.pct}%`}}/>
                </div>
                <div className="w-12 text-right text-xs text-gray-500">{f.pct}%</div>
              </div>
            ))}
          </div>
        </div>
      </>}
    </div>
    
    <div className="p-3 border-t flex justify-between">
      <div className="text-xs text-gray-400">{mappedCount} of 10 columns mapped</div>
      <button onClick={onClose} className="px-4 py-2 bg-gray-200 rounded">Close</button>
    </div>
  </div></>;
};

// Compare Modal
const CompareModal=({columns,data,onClose,onShow})=>{
  const [cmp,setCmp]=useState(null);
  const [key,setKey]=useState('');
  const [res,setRes]=useState(null);
  const [view,setView]=useState('summary');
  const [selectedCase,setSelectedCase]=useState(null);
  const [showOnlyChanged,setShowOnlyChanged]=useState(true);
  
  const upload=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{const wb=XLSX.read(ev.target.result,{type:'array',cellDates:true});const js=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:''});setCmp(js);const k=columns.find(c=>['case','caseid','id'].some(h=>c.toLowerCase().includes(h)));if(k)setKey(k);};r.readAsArrayBuffer(f);};
  
  const formatVal=(v)=>{
    if(v===null||v===undefined||v==='')return <span className="text-gray-400 italic">empty</span>;
    if(v instanceof Date)return v.toLocaleDateString();
    return String(v);
  };
  
  const run=()=>{
    const curr=new Map(),prev=new Map();
    data.forEach((r,i)=>{const k=String(r[key]||'');if(k)curr.set(k,{r,i});});
    cmp.forEach((r,i)=>{const k=String(r[key]||'');if(k)prev.set(k,{r,i});});
    const added=[],removed=[],modified=[],unchanged=[];
    
    // Helper function to normalize values for comparison
    const normalizeValue=(v)=>{
      if(v===null||v===undefined)return '';
      if(v instanceof Date){
        // Normalize dates to YYYY-MM-DD format
        return v.toISOString().split('T')[0];
      }
      // Check if string is a date
      if(typeof v==='string'){
        const trimmed=v.trim();
        // Try parsing as date
        const d=new Date(trimmed);
        if(!isNaN(d)&&trimmed.match(/^\d{4}-\d{2}-\d{2}|^\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}/)){
          return d.toISOString().split('T')[0];
        }
      }
      // For numbers, normalize to avoid floating point issues
      if(typeof v==='number'){
        return String(v);
      }
      // Default: trim whitespace and convert to string
      return String(v).trim();
    };
    
    // Helper to check if two values are equal
    const valuesEqual=(v1,v2)=>{
      const n1=normalizeValue(v1);
      const n2=normalizeValue(v2);
      return n1===n2;
    };
    
    curr.forEach((c,k)=>{
      if(!prev.has(k)){
        added.push({k,i:c.i,row:c.r});
      }else{
        const p=prev.get(k);
        const changes=[];
        columns.forEach(col=>{
          const currVal=c.r[col];
          const prevVal=p.r[col];
          if(!valuesEqual(currVal,prevVal)){
            changes.push({col,prev:prevVal,curr:currVal});
          }
        });
        if(changes.length){
          modified.push({k,i:c.i,currRow:c.r,prevRow:p.r,changes});
        }else{
          unchanged.push({k,i:c.i});
        }
      }
    });
    
    prev.forEach((p,k)=>{
      if(!curr.has(k)){
        removed.push({k,row:p.r});
      }
    });
    
    setRes({added,removed,modified,unchanged});
  };
  
  const exportChanges=()=>{
    if(!res)return;
    const rows=[];
    
    // Added cases
    res.added.forEach(a=>{
      rows.push({_Change_Type:'ADDED',_Case_Key:a.k,...a.row});
    });
    
    // Modified cases - one row per changed field
    res.modified.forEach(m=>{
      m.changes.forEach(ch=>{
        rows.push({
          _Change_Type:'MODIFIED',
          _Case_Key:m.k,
          _Changed_Field:ch.col,
          _Previous_Value:ch.prev instanceof Date?ch.prev.toLocaleDateString():String(ch.prev??''),
          _Current_Value:ch.curr instanceof Date?ch.curr.toLocaleDateString():String(ch.curr??''),
        });
      });
    });
    
    // Removed cases
    res.removed.forEach(r=>{
      rows.push({_Change_Type:'REMOVED',_Case_Key:r.k,...r.row});
    });
    
    const ws=XLSX.utils.json_to_sheet(rows);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,'Changes');
    XLSX.writeFile(wb,'comparison_results.xlsx');
  };
  
  return <><div className="modal-overlay" onClick={onClose}/><div className="modal" style={{width:900,maxHeight:'90vh',display:'flex',flexDirection:'column'}}>
    <div className="p-4 border-b flex justify-between bg-gradient-to-r from-indigo-600 to-blue-600 text-white rounded-t-lg">
      <span className="font-semibold flex items-center gap-2"><Icons.GitCompare/>Compare Versions</span>
      <button onClick={onClose} className="p-1 hover:bg-white/20 rounded"><Icons.X/></button>
    </div>
    
    {!res?<div className="p-6 overflow-auto">
      <div className="grid grid-cols-2 gap-6">
        {/* Current File */}
        <div className="border rounded-lg p-4 bg-blue-50">
          <div className="text-sm font-medium text-blue-700 mb-2">Current File</div>
          <div className="text-2xl font-bold text-blue-900">{data.length.toLocaleString()} rows</div>
          <div className="text-sm text-blue-600 mt-1">{columns.length} columns</div>
        </div>
        
        {/* Previous File */}
        <div className={`border rounded-lg p-4 ${cmp?'bg-green-50':'bg-gray-50'}`}>
          <div className={`text-sm font-medium mb-2 ${cmp?'text-green-700':'text-gray-500'}`}>Previous Version</div>
          {!cmp?<label className="flex flex-col items-center justify-center p-4 border-2 border-dashed border-gray-300 rounded cursor-pointer hover:bg-gray-100">
            <Icons.Upload/>
            <span className="mt-2 text-sm text-gray-600">Upload previous version</span>
            <input type="file" accept=".xlsx,.xls,.csv" onChange={upload} className="hidden"/>
          </label>:<>
            <div className="text-2xl font-bold text-green-900">{cmp.length.toLocaleString()} rows</div>
            <div className="text-sm text-green-600 mt-1">{Object.keys(cmp[0]||{}).length} columns</div>
            <button onClick={()=>setCmp(null)} className="mt-2 text-sm text-red-600 hover:underline">Remove</button>
          </>}
        </div>
      </div>
      
      {cmp&&<div className="mt-6">
        <div className="text-sm font-medium mb-2">Key Column (to match cases)</div>
        <select className="w-full px-3 py-2 border rounded" value={key} onChange={e=>setKey(e.target.value)}>
          <option value="">-- Select unique identifier --</option>
          {columns.map(c=><option key={c} value={c}>{c}</option>)}
        </select>
        <p className="text-xs text-gray-500 mt-1">Select the column that uniquely identifies each case (e.g., Case ID, Case Number)</p>
      </div>}
      
      <div className="mt-6 flex justify-end gap-2">
        <button onClick={onClose} className="px-4 py-2 border rounded">Cancel</button>
        <button onClick={run} disabled={!cmp||!key} className="px-4 py-2 bg-blue-600 text-white rounded disabled:opacity-50">
          Compare
        </button>
      </div>
    </div>:
    
    /* Results View */
    <><div className="flex border-b">
      {[
        {id:'summary',label:'Summary',count:null},
        {id:'added',label:'Added',count:res.added.length,color:'green'},
        {id:'modified',label:'Modified',count:res.modified.length,color:'amber'},
        {id:'removed',label:'Removed',count:res.removed.length,color:'red'},
      ].map(t=>(
        <button key={t.id} onClick={()=>{setView(t.id);setSelectedCase(null);}} className={`flex-1 py-3 text-sm flex items-center justify-center gap-2 ${view===t.id?'border-b-2 border-blue-600 text-blue-600 bg-blue-50':'text-gray-500 hover:bg-gray-50'}`}>
          {t.label}
          {t.count!==null&&<span className={`px-2 py-0.5 rounded text-xs bg-${t.color}-100 text-${t.color}-700`}>{t.count}</span>}
        </button>
      ))}
    </div>
    
    <div className="flex-1 overflow-auto">
      {/* Summary View */}
      {view==='summary'&&<div className="p-6">
        <div className="grid grid-cols-4 gap-4 mb-6">
          <div className="bg-green-50 border border-green-200 rounded-lg p-4 text-center cursor-pointer hover:bg-green-100" onClick={()=>setView('added')}>
            <div className="text-3xl font-bold text-green-700">{res.added.length}</div>
            <div className="text-sm text-green-600">New Cases</div>
          </div>
          <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 text-center cursor-pointer hover:bg-amber-100" onClick={()=>setView('modified')}>
            <div className="text-3xl font-bold text-amber-700">{res.modified.length}</div>
            <div className="text-sm text-amber-600">Modified Cases</div>
          </div>
          <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-center cursor-pointer hover:bg-red-100" onClick={()=>setView('removed')}>
            <div className="text-3xl font-bold text-red-700">{res.removed.length}</div>
            <div className="text-sm text-red-600">Removed Cases</div>
          </div>
          <div className="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center">
            <div className="text-3xl font-bold text-gray-700">{res.unchanged.length}</div>
            <div className="text-sm text-gray-600">Unchanged</div>
          </div>
        </div>
        
        {/* Most Changed Fields */}
        {res.modified.length>0&&<div className="border rounded-lg p-4 mb-6">
          <h3 className="font-semibold mb-3">Most Frequently Changed Fields</h3>
          <div className="space-y-2">
            {Object.entries(
              res.modified.flatMap(m=>m.changes.map(c=>c.col))
                .reduce((acc,col)=>{acc[col]=(acc[col]||0)+1;return acc;},{})
            ).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([col,count],i)=>(
              <div key={i} className="flex items-center gap-3">
                <div className="w-40 text-sm truncate">{col}</div>
                <div className="flex-1 h-4 bg-gray-100 rounded overflow-hidden">
                  <div className="h-full bg-amber-500 rounded" style={{width:`${count/res.modified.length*100}%`}}/>
                </div>
                <div className="text-sm text-gray-600">{count} changes</div>
              </div>
            ))}
          </div>
        </div>}
        
        <div className="flex gap-3">
          <button onClick={()=>{onShow(res.added.map(a=>a.i));onClose();}} disabled={!res.added.length} className="px-4 py-2 bg-green-100 text-green-700 rounded text-sm disabled:opacity-50">
            Show Added in Table
          </button>
          <button onClick={()=>{onShow(res.modified.map(m=>m.i));onClose();}} disabled={!res.modified.length} className="px-4 py-2 bg-amber-100 text-amber-700 rounded text-sm disabled:opacity-50">
            Show Modified in Table
          </button>
          <button onClick={exportChanges} className="px-4 py-2 bg-blue-100 text-blue-700 rounded text-sm">
            <Icons.Download/> Export All Changes
          </button>
        </div>
      </div>}
      
      {/* Added Cases View */}
      {view==='added'&&<div className="p-4">
        {res.added.length===0?<div className="text-center py-12 text-gray-500">No new cases found</div>:<>
          <div className="flex justify-between items-center mb-4">
            <span className="text-sm text-gray-600">{res.added.length} new cases in current file</span>
            <button onClick={()=>{onShow(res.added.map(a=>a.i));onClose();}} className="px-3 py-1 bg-green-600 text-white rounded text-sm">Show All in Table</button>
          </div>
          <div className="border rounded-lg overflow-hidden">
            <table className="w-full text-sm">
              <thead className="bg-green-50">
                <tr>
                  <th className="p-2 text-left border-b">Case Key</th>
                  {columns.slice(0,4).map(col=><th key={col} className="p-2 text-left border-b">{col}</th>)}
                </tr>
              </thead>
              <tbody>
                {res.added.slice(0,50).map((a,i)=>(
                  <tr key={i} className="border-b hover:bg-green-50 cursor-pointer" onClick={()=>setSelectedCase({type:'added',data:a})}>
                    <td className="p-2 font-medium text-green-700">{a.k}</td>
                    {columns.slice(0,4).map(col=><td key={col} className="p-2 truncate max-w-[150px]">{formatVal(a.row[col])}</td>)}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          {res.added.length>50&&<div className="text-center text-sm text-gray-500 mt-2">Showing 50 of {res.added.length}</div>}
        </>}
      </div>}
      
      {/* Modified Cases View */}
      {view==='modified'&&<div className="p-4">
        {res.modified.length===0?<div className="text-center py-12 text-gray-500">No modified cases found</div>:<>
          <div className="flex justify-between items-center mb-4">
            <span className="text-sm text-gray-600">{res.modified.length} cases with changes</span>
            <div className="flex gap-2">
              <button onClick={()=>{onShow(res.modified.map(m=>m.i));onClose();}} className="px-3 py-1 bg-amber-600 text-white rounded text-sm">Show All in Table</button>
            </div>
          </div>
          
          {!selectedCase?<div className="border rounded-lg overflow-hidden">
            <table className="w-full text-sm">
              <thead className="bg-amber-50">
                <tr>
                  <th className="p-2 text-left border-b">Case Key</th>
                  <th className="p-2 text-left border-b"># Changes</th>
                  <th className="p-2 text-left border-b">Changed Fields</th>
                  <th className="p-2 text-left border-b"></th>
                </tr>
              </thead>
              <tbody>
                {res.modified.slice(0,50).map((m,i)=>(
                  <tr key={i} className="border-b hover:bg-amber-50 cursor-pointer" onClick={()=>setSelectedCase({type:'modified',data:m})}>
                    <td className="p-2 font-medium text-amber-700">{m.k}</td>
                    <td className="p-2"><span className="px-2 py-0.5 bg-amber-100 text-amber-700 rounded">{m.changes.length}</span></td>
                    <td className="p-2 text-gray-600 truncate max-w-[300px]">{m.changes.map(c=>c.col).join(', ')}</td>
                    <td className="p-2 text-blue-600">View →</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>:
          
          /* Side-by-side comparison for selected case */
          <div className="border rounded-lg overflow-hidden">
            <div className="bg-amber-50 p-3 flex justify-between items-center border-b">
              <div>
                <span className="font-semibold">Case: {selectedCase.data.k}</span>
                <span className="ml-3 text-sm text-gray-600">{selectedCase.data.changes.length} field(s) changed</span>
              </div>
              <button onClick={()=>setSelectedCase(null)} className="text-sm text-blue-600 hover:underline">← Back to list</button>
            </div>
            
            <div className="p-3 border-b bg-gray-50 flex items-center gap-4">
              <label className="flex items-center gap-2 text-sm">
                <input type="checkbox" checked={showOnlyChanged} onChange={e=>setShowOnlyChanged(e.target.checked)}/>
                Show only changed fields
              </label>
            </div>
            
            <table className="w-full text-sm">
              <thead className="bg-gray-100">
                <tr>
                  <th className="p-2 text-left border-b w-1/4">Field</th>
                  <th className="p-2 text-left border-b w-1/3 bg-red-50 text-red-700">Previous Value</th>
                  <th className="p-2 text-left border-b w-1/3 bg-green-50 text-green-700">Current Value</th>
                  <th className="p-2 text-left border-b w-16">Status</th>
                </tr>
              </thead>
              <tbody>
                {(showOnlyChanged?selectedCase.data.changes.map(c=>({col:c.col,prev:c.prev,curr:c.curr,changed:true})):
                  columns.map(col=>{
                    const change=selectedCase.data.changes.find(c=>c.col===col);
                    return {col,prev:selectedCase.data.prevRow[col],curr:selectedCase.data.currRow[col],changed:!!change};
                  })
                ).map((row,i)=>(
                  <tr key={i} className={`border-b ${row.changed?'bg-amber-50':''}`}>
                    <td className="p-2 font-medium">{row.col}</td>
                    <td className={`p-2 ${row.changed?'bg-red-50':''}`}>{formatVal(row.prev)}</td>
                    <td className={`p-2 ${row.changed?'bg-green-50':''}`}>{formatVal(row.curr)}</td>
                    <td className="p-2">{row.changed&&<span className="text-xs bg-amber-200 text-amber-800 px-2 py-0.5 rounded">Changed</span>}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>}
        </>}
      </div>}
      
      {/* Removed Cases View */}
      {view==='removed'&&<div className="p-4">
        {res.removed.length===0?<div className="text-center py-12 text-gray-500">No removed cases found</div>:<>
          <div className="flex justify-between items-center mb-4">
            <span className="text-sm text-gray-600">{res.removed.length} cases removed (in previous but not in current)</span>
          </div>
          <div className="border rounded-lg overflow-hidden">
            <table className="w-full text-sm">
              <thead className="bg-red-50">
                <tr>
                  <th className="p-2 text-left border-b">Case Key</th>
                  {columns.slice(0,4).map(col=><th key={col} className="p-2 text-left border-b">{col}</th>)}
                </tr>
              </thead>
              <tbody>
                {res.removed.slice(0,50).map((r,i)=>(
                  <tr key={i} className="border-b hover:bg-red-50 cursor-pointer" onClick={()=>setSelectedCase({type:'removed',data:r})}>
                    <td className="p-2 font-medium text-red-700">{r.k}</td>
                    {columns.slice(0,4).map(col=><td key={col} className="p-2 truncate max-w-[150px]">{formatVal(r.row?.[col])}</td>)}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          {res.removed.length>50&&<div className="text-center text-sm text-gray-500 mt-2">Showing 50 of {res.removed.length}</div>}
        </>}
      </div>}
    </div>
    
    {/* Case Detail Drawer for Added/Removed */}
    {selectedCase&&(selectedCase.type==='added'||selectedCase.type==='removed')&&<div className="border-t bg-gray-50 p-4 max-h-64 overflow-auto">
      <div className="flex justify-between items-center mb-3">
        <span className="font-semibold">{selectedCase.type==='added'?'New':'Removed'} Case: {selectedCase.data.k}</span>
        <button onClick={()=>setSelectedCase(null)} className="text-sm text-gray-500 hover:text-gray-700">Close</button>
      </div>
      <div className="grid grid-cols-3 gap-2 text-sm">
        {columns.map(col=>(
          <div key={col} className="flex">
            <span className="text-gray-500 w-1/2 truncate">{col}:</span>
            <span className="w-1/2 truncate">{formatVal(selectedCase.data.row?.[col])}</span>
          </div>
        ))}
      </div>
    </div>}
    
    <div className="p-3 border-t flex justify-between">
      <button onClick={()=>setRes(null)} className="text-blue-600 hover:underline">← New Comparison</button>
      <button onClick={onClose} className="px-4 py-2 bg-gray-200 rounded">Close</button>
    </div></>}
  </div></>;
};

// Main App
function App(){
  const [data,setData]=useState([]);
  const [columns,setColumns]=useState([]);
  const [fileName,setFileName]=useState('');
  const [filters,setFilters]=useState({});
  const [loading,setLoading]=useState(false);
  const [loadProgress,setLoadProgress]=useState(0);
  const [search,setSearch]=useState('');
  const [config,setConfig]=useState({});
  const [frozen,setFrozen]=useState([]);
  const [views,setViews]=useState([]);
  const [sort,setSort]=useState({col:null,dir:'asc'});
  const [page,setPage]=useState(1);
  const [filterCol,setFilterCol]=useState(null);
  const [statsCol,setStatsCol]=useState(null);
  const [showDup,setShowDup]=useState(false);
  const [showQC,setShowQC]=useState(false);
  const [showCmp,setShowCmp]=useState(false);
  const [rules,setRules]=useState(()=>DEFAULT_RULES.map(r=>({...r,conditions:r.conditions.map(c=>({...c}))})));
  const [highlight,setHighlight]=useState([]);
  const [showOnly,setShowOnly]=useState(null);
  const [showSummary,setShowSummary]=useState(false);
  const perPage=100;

const upload=useCallback(e=>{
  const f=e.target.files[0];if(!f)return;
  setLoading(true);
  setLoadProgress(0);
  const r=new FileReader();
  r.onprogress=(event)=>{
    if(event.lengthComputable){
      const pct=Math.round((event.loaded/event.total)*50);
      setLoadProgress(pct);
    }
  };
  r.onload=ev=>{
    setLoadProgress(60);
    setTimeout(()=>{
      const wb=XLSX.read(ev.target.result,{type:'array',cellDates:true});
      setLoadProgress(80);
      setTimeout(()=>{
        const js=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:''});
        const cols=js.length?Object.keys(js[0]):[];
        setLoadProgress(95);
        setTimeout(()=>{
          setData(js);setColumns(cols);setFileName(f.name);
          const c={};cols.forEach((col,i)=>c[col]={visible:true,order:i});
          setConfig(c);setFilters({});setHighlight([]);setShowOnly(null);setPage(1);setFrozen([]);
          setLoadProgress(100);
          setTimeout(()=>{setLoading(false);setLoadProgress(0);},300);
        },0);
      },0);
    },0);
  };
  r.readAsArrayBuffer(f);
},[]);

  const handleShow=idxs=>{setShowOnly(idxs);setHighlight(idxs);};
  const applyView=v=>{setConfig(v.config);setFrozen(v.frozen||[]);};
  
  const filtered=useMemo(()=>{
    let res=showOnly?data.filter((_,i)=>showOnly.includes(i)):data;
    if(!showOnly){
      Object.entries(filters).forEach(([col,filter])=>{
        if(!filter)return;
        if(filter.type==='date'){
          const {dateRange,includeBlank}=filter;
          res=res.filter(r=>{const v=r[col];const isEmpty=!v||!String(v).trim();if(isEmpty)return includeBlank;const d=v instanceof Date?v:new Date(v);if(isNaN(d))return false;const dateStr=d.toISOString().split('T')[0];if(dateRange.from&&dateStr<dateRange.from)return false;if(dateRange.to&&dateStr>dateRange.to)return false;return true;});
        }else if(filter.type==='values'){
          const vals=filter.values;
          if(vals?.length)res=res.filter(r=>{const v=r[col];const blank=!v||!String(v).trim();return(vals.includes(BLANK)&&blank)||(!blank&&vals.includes(String(v)));});
        }
      });
      if(search){const t=search.toLowerCase();res=res.filter(r=>Object.values(r).some(v=>String(v).toLowerCase().includes(t)));}
    }
    if(sort.col)res=_.orderBy(res,[sort.col],[sort.dir]);
    return res;
  },[data,filters,search,sort,showOnly]);

  const visible=useMemo(()=>columns.filter(c=>config[c]?.visible!==false).sort((a,b)=>(config[a]?.order??0)-(config[b]?.order??0)),[columns,config]);
  const pages=Math.ceil(filtered.length/perPage);
  const pageData=filtered.slice((page-1)*perPage,page*perPage);

  useEffect(()=>{setPage(1);},[filters,search,showOnly]);

  const exportData=()=>{const ws=XLSX.utils.json_to_sheet(filtered);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Data');XLSX.writeFile(wb,'filtered_'+fileName);};
  const getFrozenStyle=col=>{const i=frozen.indexOf(col);if(i===-1)return{};let left=50;for(let j=0;j<i;j++)left+=150;return{position:'sticky',left,zIndex:5,background:'#eff6ff'};};

 if(!data.length)return(
  <div className="min-h-screen flex items-center justify-center p-8">
    <div className="bg-white rounded-xl shadow-lg p-8 max-w-lg w-full text-center">
      <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4"><Icons.BarChart/></div>
      <h1 className="text-2xl font-bold mb-2">PV Line Listing Analyzer</h1>
      <p className="text-gray-600 mb-2">Analyze pharmacovigilance line listings in your browser</p>
      <div className="bg-green-50 border border-green-200 rounded p-3 mb-6 text-sm text-green-700"><Icons.Shield/> All processing is local. No data uploaded.</div>
      {loading?<div className="w-full">
        <div className="flex items-center justify-center gap-3 mb-3">
          <svg className="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
          <span className="text-blue-600 font-medium">Loading file...</span>
        </div>
        <div className="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
          <div className="bg-blue-600 h-full rounded-full transition-all duration-300 ease-out" style={{width:`${loadProgress}%`}}></div>
        </div>
        <div className="text-sm text-gray-500 mt-2">{loadProgress}% complete</div>
      </div>:<label className="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-lg cursor-pointer hover:bg-blue-700"><Icons.Upload/>Select Excel/CSV File<input type="file" accept=".xlsx,.xls,.csv" onChange={upload} className="hidden"/></label>}
    </div>
  </div>
);

  return(
    <div className="min-h-screen bg-gray-50">
      {filterCol&&<FilterModal col={filterCol} data={data} filters={filters} setFilters={setFilters} onClose={()=>setFilterCol(null)}/>}
      {statsCol&&<StatsModal col={statsCol} data={data} onClose={()=>setStatsCol(null)}/>}
      {showDup&&<DupModal columns={columns} data={data} onClose={()=>setShowDup(false)} onShow={handleShow}/>}
      {showQC&&<QCModal columns={columns} data={data} onClose={()=>setShowQC(false)} onShow={handleShow} rules={rules} setRules={setRules}/>}
      {showSummary&&<SummaryModal columns={columns} data={data} onClose={()=>setShowSummary(false)}/>}
      {showCmp&&<CompareModal columns={columns} data={data} onClose={()=>setShowCmp(false)} onShow={handleShow}/>}
      
      <header className="bg-white border-b px-4 py-3 flex items-center justify-between flex-wrap gap-3">
        <div><h1 className="text-lg font-semibold">PV Line Listing Analyzer</h1><p className="text-sm text-gray-500">{fileName} • {filtered.length.toLocaleString()} of {data.length.toLocaleString()} rows</p></div>
        <div className="flex gap-2">
          <button onClick={exportData} className="flex items-center gap-2 px-3 py-2 bg-green-100 text-green-700 rounded text-sm hover:bg-green-200"><Icons.Download/>Export</button>
          <label className="flex items-center gap-2 px-3 py-2 bg-gray-100 rounded text-sm cursor-pointer hover:bg-gray-200"><Icons.Upload/>New<input type="file" accept=".xlsx,.xls,.csv" onChange={upload} className="hidden"/></label>
        </div>
      </header>

      <div className="bg-white border-b px-4 py-2 flex items-center gap-3 flex-wrap">
        <div className="relative flex-1 max-w-md"><span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><Icons.Search/></span><input type="text" placeholder="Search..." value={search} onChange={e=>setSearch(e.target.value)} className="w-full pl-9 pr-4 py-2 border rounded-lg text-sm"/></div>
        <ColManager columns={columns} config={config} setConfig={setConfig} frozen={frozen} setFrozen={setFrozen}/>
        <ViewsManager views={views} setViews={setViews} config={config} frozen={frozen} applyView={applyView}/>
        <button onClick={()=>setShowSummary(true)} className="flex items-center gap-2 px-3 py-2 bg-blue-100 text-blue-700 rounded text-sm hover:bg-blue-200"><Icons.PieChart/>Summary</button>
        <button onClick={()=>setShowDup(true)} className="flex items-center gap-2 px-3 py-2 bg-gray-100 rounded text-sm hover:bg-gray-200"><Icons.Copy/>Duplicates</button>
        <button onClick={()=>setShowCmp(true)} className="flex items-center gap-2 px-3 py-2 bg-gray-100 rounded text-sm hover:bg-gray-200"><Icons.GitCompare/>Compare</button>
        <button onClick={()=>setShowQC(true)} className="flex items-center gap-2 px-3 py-2 bg-purple-100 text-purple-700 rounded text-sm hover:bg-purple-200"><Icons.AlertTriangle/>QC Rules</button>
        {Object.keys(filters).length>0&&<button onClick={()=>setFilters({})} className="flex items-center gap-1 px-3 py-2 bg-blue-100 text-blue-700 rounded text-sm"><Icons.X/>Clear filters</button>}
        {showOnly&&<button onClick={()=>{setShowOnly(null);setHighlight([]);}} className="flex items-center gap-1 px-3 py-2 bg-amber-100 text-amber-700 rounded text-sm"><Icons.X/>Clear view ({showOnly.length})</button>}
      </div>

      <div className="overflow-auto" style={{maxHeight:'calc(100vh - 180px)'}}>
        <table className="w-full text-sm border-collapse">
          <thead className="bg-gray-100 sticky top-0 z-20">
            <tr>
              <th className="p-2 border-b border-r bg-gray-100" style={{position:'sticky',left:0,zIndex:25,minWidth:50}}>#</th>
              {visible.map(col=>{const fr=frozen.includes(col);const st={...getFrozenStyle(col),minWidth:150};if(fr)st.background='#e5e7eb';
                const hasFilter=filters[col]&&(filters[col].type==='date'?(filters[col].dateRange?.from||filters[col].dateRange?.to||filters[col].includeBlank):filters[col].type==='values'&&filters[col].values?.length);
                return<th key={col} className="p-2 border-b border-r text-left bg-gray-100" style={st}>
                  <div className="flex items-center gap-1">{fr&&<Icons.Lock/>}
                    <span className="truncate cursor-pointer hover:text-blue-600" onClick={()=>setSort(p=>({col,dir:p.col===col&&p.dir==='asc'?'desc':'asc'}))}>{col}</span>
                    {sort.col===col&&(sort.dir==='asc'?<Icons.ChevronUp/>:<Icons.ChevronDown/>)}
                    <button onClick={()=>setStatsCol(col)} className="p-1 text-gray-400 hover:text-purple-600"><Icons.BarChart/></button>
                    <button onClick={()=>setFilterCol(col)} className={`p-1 ${hasFilter?'text-blue-600':'text-gray-400'}`}><Icons.Filter/></button>
                  </div>
                </th>;})}
            </tr>
          </thead>
          <tbody>
            {pageData.map((row,i)=>{const idx=(page-1)*perPage+i;const oi=data.indexOf(row);const hl=highlight.includes(oi);
              return<tr key={i} className={`border-b hover:bg-gray-50 ${hl?'bg-amber-50':''}`}>
                <td className="p-2 border-r text-gray-400" style={{position:'sticky',left:0,zIndex:4,background:hl?'#fef3c7':'#fff',minWidth:50}}>{idx+1}</td>
                {visible.map(col=>{const fr=frozen.includes(col);const st={...getFrozenStyle(col),minWidth:150};if(hl)st.background='#fef3c7';else if(fr)st.background='#eff6ff';
                  return<td key={col} className="p-2 border-r truncate max-w-[250px]" style={st} title={String(row[col]||'')}>{row[col] instanceof Date?row[col].toLocaleDateString():String(row[col]??'')}</td>;})}
              </tr>;})}
            {pageData.length===0&&<tr><td colSpan={visible.length+1} className="p-8 text-center text-gray-500">No data</td></tr>}
          </tbody>
        </table>
      </div>

      {pages>1&&<footer className="bg-white border-t px-4 py-3 flex items-center justify-between">
        <span className="text-sm text-gray-600">Page {page} of {pages}</span>
        <div className="flex gap-2">
          <button onClick={()=>setPage(1)} disabled={page===1} className="px-3 py-1 border rounded disabled:opacity-50">First</button>
          <button onClick={()=>setPage(p=>p-1)} disabled={page===1} className="px-3 py-1 border rounded disabled:opacity-50">Prev</button>
          <button onClick={()=>setPage(p=>p+1)} disabled={page===pages} className="px-3 py-1 border rounded disabled:opacity-50">Next</button>
          <button onClick={()=>setPage(pages)} disabled={page===pages} className="px-3 py-1 border rounded disabled:opacity-50">Last</button>
        </div>
      </footer>}
    </div>
  );
}

ReactDOM.render(<App/>,document.getElementById('root'));
</script>
</body>
</html>
